# REPRODUCIBILITY

## macOS (Android)

### Toolchain
- JDK: 21 (Temurin or equivalent)
- Gradle: 9.1.0 (wrapper)
- Android Gradle Plugin: 9.0.0
- Android SDK:
  - Platform: 35
  - Build-tools: 36.0.0 (auto-installed by Gradle during build)

### Build
From repo root:

```
cd android-kotlin
./gradlew :app:assembleDebug
./gradlew :app:test
```

### Run
- Open `android-kotlin/` in Android Studio.
- Run the `app` configuration on an emulator or device (minSdk 26).

### Notes / pitfalls
- On first build, Gradle may download Android SDK components (build-tools/platform).
- Instrumented tests require a connected device or emulator.
- LLM Inference (Gemma-3n) is not reliable on emulators; run captioning tests on a physical device.
- MediaPipe `tasks-genai` requires JDK 21 (classfile version 65). Ensure Android Studio/Gradle uses JDK 21.
### ObjectBox database location (Android device)
- Default ObjectBox directory (created by `androidContext(context)`):
  - `/data/data/com.screenshotsearcher/files/objectbox` (or `/data/user/0/com.screenshotsearcher/files/objectbox`)
- Quick check (debuggable builds):
  - `adb shell run-as com.screenshotsearcher ls -la files/objectbox`
- Delete ObjectBox DB only (debuggable builds):
  - `adb shell run-as com.screenshotsearcher rm -rf files/objectbox`
- Reset app data (clears ObjectBox DB + prefs + caches):
  - `adb shell pm clear com.screenshotsearcher`
- Logcat also prints the path on app start: tag `ObjectBox`, message “Store directory: …”

### Notes / pitfalls (androidTest)
- `androidTest` code should avoid `toUri()` unless `androidx.core:core-ktx` is added to the androidTest configuration; prefer `Uri.fromFile(...)` for file URIs in tests.
- Image labeling tests use `androidTest` assets; load them via `InstrumentationRegistry.getInstrumentation().context` (test APK assets), not `targetContext`.

### MediaPipe Text Embedder model
- Place the text embedder model at: `android-kotlin/app/src/main/assets/models/text_embedder.tflite`
- The app and instrumented tests will fail if the model asset is missing.

### Model assets
- Text Embedder model downloaded to `android-kotlin/app/src/main/assets/models/text_embedder.tflite` (USE). Required for semantic embedding tests.
- `connectedAndroidTest` requires a running emulator or device.

### ~~MediaPipe Image Embedder model~~
~~- Place the image embedder model at: `android-kotlin/app/src/main/assets/models/image_embedder.tflite`~~
~~- Image similarity tests require the model asset and a connected device.~~

### ML Kit Image Labeling (Package 4)
- Dependency: `com.google.mlkit:image-labeling:17.0.8`.
- Instrumented test uses `android-kotlin/app/src/androidTest/assets/label_fixture.jpg` and expects a food/fruit label ≥ 0.70 confidence.

### Metadata capture (Package 4.1)
- Metadata is extracted from EXIF (when present), then MediaStore, then file/bitmap fallback.
- Dominant colors are computed from a scaled bitmap (no network).
- Description is generated by on-device Gemma-3n captioning via MediaPipe LLM Inference (no network).

### Image captioning model (Package 4.1)
- Model is **not** bundled in the APK (too large). Push to device:
  - `adb shell mkdir -p /data/local/tmp/llm`
  - `adb push /Users/vivien/Gemma/gemma-3n-E2B-it-int4.litertlm /data/local/tmp/llm/`
- LLM Inference loads the model from `/data/local/tmp/llm/gemma-3n-E2B-it-int4.litertlm`.
- If that build crashes with `Unknown model type: tf_lite_audio_adapter`, try the Web build:
  - `adb push /Users/vivien/Gemma/gemma-3n-E2B-it-int4-Web.litertlm /data/local/tmp/llm/`
- In Settings, use **Gemma captioning** → “Refresh model status” to verify install; “Warm up” preloads once, “Release” clears.

### MediaPipe Text Embedder test failures (resolved)
~~- `connectedAndroidTest` previously failed with `TextEmbedderGraph` missing when both `tasks-text` and `tasks-vision` were present.~~
~~- Resolution: Split into flavors `textOnly` and `visionOnly` so each APK includes only one MediaPipe tasks library.~~

### ~~MediaPipe JNI conflict: tasks-text + tasks-vision (workaround in place)~~
~~- Current approach: Use product flavors.~~
~~- `./gradlew :app:connectedAndroidTest` runs both `connectedTextOnlyDebugAndroidTest` and `connectedVisionOnlyDebugAndroidTest`.~~
~~- Limitation: A single process should not load both `tasks-text` and `tasks-vision` simultaneously.~~

### Image similarity removal
- Image similarity search and MediaPipe `tasks-vision` have been removed; the app uses a single debug variant.

### Text embedder model: 100-dim, not 512-dim
- The USE TFLite model outputs **100-dimensional** vectors, not 512 as SPECS assumed.
- `Screenshot.kt` entity and `TextEmbeddingInstrumentedTest.kt` are updated to 100-dim in the working tree (uncommitted).
- Not yet verified on device — should be confirmed by running `TextEmbeddingInstrumentedTest` on a connected device.
